import asyncio
import datetime
import json
import logging
import os
import re
from typing import Optional

from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import Command
from aiogram.types import (
    Message, CallbackQuery,
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton,
    ReplyKeyboardRemove
)
from dotenv import load_dotenv

# Sozlamalar
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_IDS = list(map(int, os.getenv("ADMIN_IDS", "").split(","))) if os.getenv("ADMIN_IDS") else []

if not BOT_TOKEN:
    raise ValueError("âŒ BOT_TOKEN .env faylida yo'q!")

# Bot - to'g'ri konfiguratsiya
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# Modullar
from database.db_manager import db
from handlers.analyzer import analyze_message, analyze_message_advanced
from handlers.ai_analyzer import ai_analyzer
from handlers.url_scanner import url_scanner
from handlers.file_analyzer import file_analyzer
from handlers.future_features import FutureFeatures
from handlers.monitor import monitor
from handlers.virustotal_client import vt_client

future_features = FutureFeatures(db)

# Admin tekshirish
def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

# --- YORDAMCHI FUNKSIYALAR ---
def get_user_link(user: types.User) -> str:
    if user.username:
        return f'<a href="https://t.me/{user.username}">{user.full_name}</a>'
    else:
        return f'<a href="tg://user?id={user.id}">{user.full_name}</a>'

def get_main_keyboard(user_id: Optional[int] = None) -> ReplyKeyboardMarkup:
    unread_count = 0
    if user_id:
        unread_count = db.get_unread_messages_count(user_id, is_admin=False)
    
    support_text = f"ğŸ“© Admin ({unread_count})" if unread_count > 0 else "ğŸ“© Admin bilan bog'lanish"
    
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸ” Tekshirish"), KeyboardButton(text="ğŸ“Š Mening statistikam")],
            [KeyboardButton(text=support_text), KeyboardButton(text="ğŸ›¡ï¸ Xavfsizlik tavsiyalari")],
            [KeyboardButton(text="â„¹ï¸ Yordam")]
        ],
        resize_keyboard=True
    )
    return keyboard

def get_admin_keyboard() -> ReplyKeyboardMarkup:
    unread_count = db.get_unread_messages_count(is_admin=True)
    support_text = f"ğŸ“¨ Support ({unread_count})" if unread_count > 0 else "ğŸ“¨ Support"
    
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸ‘¥ Foydalanuvchilar"), KeyboardButton(text=support_text)],
            [KeyboardButton(text="ğŸ“ˆ Statistika"), KeyboardButton(text="ğŸš¨ Xavflar ro'yxati")],
            [KeyboardButton(text="ğŸ“Š Hisobot"), KeyboardButton(text="â¬…ï¸ Asosiy menyu")]
        ],
        resize_keyboard=True
    )
    return keyboard

def format_time_difference(dt_str: str) -> str:
    """Vaqt farqini formatlash"""
    if not dt_str:
        return "Noma'lum"
    
    try:
        dt = datetime.datetime.strptime(dt_str, "%Y-%m-%d %H:%M:%S")
        now = datetime.datetime.now()
        diff = now - dt
        
        if diff.days > 0:
            return f"{diff.days} kun oldin"
        elif diff.seconds > 3600:
            hours = diff.seconds // 3600
            return f"{hours} soat oldin"
        elif diff.seconds > 60:
            minutes = diff.seconds // 60
            return f"{minutes} daqiqa oldin"
        else:
            return f"{diff.seconds} soniya oldin"
    except:
        return dt_str

# ================ START VA YORDAM ================
@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    welcome_text = (
        "ğŸ›¡ï¸ <b>Kiber-Inspektor</b>\n\n"
        "Men firibgarlik, phishing va boshqa kiberxavflarni aniqlayman!\n\n"
        "<b>Asosiy funksiyalar:</b>\n"
        "âœ… Matn va havolalarni tekshirish\n"
        "âœ… Fayllarni tahlil qilish\n"
        "âœ… Real-time monitoring\n"
        "âœ… Guruhlarni himoya qilish\n"
        "âœ… Admin bilan bog'lanish\n\n"
        "Quyidagi tugmalar orqali foydalanishingiz mumkin:"
    )
    
    await message.answer(welcome_text, reply_markup=get_main_keyboard(message.from_user.id))
    
    db.add_user(message.from_user.id, message.from_user.username, message.from_user.full_name)
    if message.chat.type in ["group", "supergroup"]:
        db.add_group(message.chat.id, message.chat.title)

@dp.message(Command("myid"))
async def myid_cmd(message: types.Message):
    """Foydalanuvchi ID sini ko'rish"""
    user_id = message.from_user.id
    await message.answer(
        f"ğŸ†” <b>Sizning ID ingiz:</b> <code>{user_id}</code>\n\n"
        f"ğŸ“› Ism: {message.from_user.full_name}\n"
        f"ğŸ“§ Username: @{message.from_user.username or 'Yo\'q'}\n\n"
        f"<i>Bu ID ni .env faylida ADMIN_IDS ga qo'shing</i>"
    )
    
@dp.message(F.text == "â„¹ï¸ Yordam")
@dp.message(Command("help"))
async def help_cmd(message: types.Message):
    help_text = (
        "<b>ğŸ†˜ Kiber-Inspektor Yordam</b>\n\n"
        "<b>ğŸ”§ Asosiy Buyruqlar:</b>\n"
        "/start - Botni ishga tushirish\n"
        "/help - Yordam\n"
        "/check [matn] - Matnni tekshirish\n"
        "/scanurl [havola] - URL ni skanerlash\n"
        "/mystats - Shaxsiy statistika\n"
        "/support - Admin bilan bog'lanish\n\n"
        
        "<b>ğŸ’¬ Admin bilan bog'lanish:</b>\n"
        "1. 'ğŸ“© Admin bilan bog'lanish' tugmasini bosing\n"
        "2. So'rovingiz mavzusini yozing\n"
        "3. Xabaringizni yozing\n"
        "4. Admin tez orada javob beradi\n\n"
        
        "<i>Bot guruhlarga qo'shilsa, avtomatik xabarlarni tekshiradi!</i>"
    )
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ” Tekshirishni boshlash", callback_data="start_check")],
        [InlineKeyboardButton(text="ğŸ“© Admin bilan bog'lanish", callback_data="start_support")],
        [InlineKeyboardButton(text="ğŸ›¡ï¸ Xavfsizlik tavsiyalari", callback_data="safety_tips")]
    ])
    
    await message.answer(help_text, reply_markup=keyboard)

# ================ TEKSHIRISH FUNKSIYALARI ================
@dp.message(F.text == "ğŸ” Tekshirish")
@dp.message(Command("check"))
async def check_cmd(message: types.Message):
    if message.text == "ğŸ” Tekshirish":
        await message.answer(
            "ğŸ“ <b>Matnni yuboring yoki /check [matn] buyrug'idan foydalaning</b>\n\n"
            "Misol: <code>/check bu mukofot yutishingiz mumkin</code>\n"
            "Misol: <code>/check https://xato-havola.tk</code>",
            reply_markup=ReplyKeyboardRemove()
        )
        return
    
    text = message.text.replace("/check", "").strip()
    if not text:
        await message.answer("âŒ Matn kiriting: <code>/check [matn]</code>")
        return
    
    await process_text_analysis(message, text)

async def process_text_analysis(message: types.Message, text: str):
    loading_msg = await message.answer("ğŸ” <b>Tahlil qilinmoqda...</b>")
    
    try:
        all_threats = []
        severity = "Safe"
        details = []
        
        # 1. Asosiy tahlil
        threat1, sev1 = analyze_message(text)
        threats2, sev2 = analyze_message_advanced(text)
        
        if threat1: 
            all_threats.append(threat1)
            details.append(f"â€¢ {threat1}")
        if threats2: 
            all_threats.extend(threats2)
            for t in threats2:
                details.append(f"â€¢ {t}")
        severity = sev2 if sev2 != "Safe" else sev1
        
        # 2. AI tahlil
        is_scam, probability = ai_analyzer.predict(text)
        if is_scam and probability > 0.7:
            all_threats.append(f"AI tahlili: Scam ehtimoli {probability:.0%}")
            details.append(f"â€¢ AI tahlili: {probability:.1%} ehtimollik")
            severity = "High" if severity != "Critical" else "Critical"
        
        # 3. URL tekshirish
        urls = re.findall(r'https?://[^\s]+', text.lower())
        if urls and url_scanner:
            url_results = await url_scanner.check_url_multiple_sources(urls[0])
            for result in url_results:
                if result.get("suspicious"):
                    all_threats.append("Shubhali havola")
                    details.append(f"â€¢ {result.get('check', 'URL')}: shubhali")
                    severity = "Medium" if severity not in ["High", "Critical"] else severity
        
        # Xususiy kalit so'zlar
        suspicious_keywords = {
            "mukofot": "Scam",
            "yutuq": "Scam", 
            "pul": "Scam",
            "parol": "Phishing",
            "karta": "Phishing",
            "shaxsiy": "Phishing"
        }
        
        for keyword, threat_type in suspicious_keywords.items():
            if keyword in text.lower():
                if threat_type not in all_threats:
                    all_threats.append(threat_type)
                    details.append(f"â€¢ {keyword} so'zi topildi")
        
        # Natijani tayyorlash
        if all_threats:
            result_text = f"âš ï¸ <b>{len(all_threats)} TA XAVF ANIQLANDI:</b>\n\n"
            for i, threat in enumerate(all_threats[:5], 1):
                result_text += f"{i}. {threat}\n"
            
            result_text += f"\nğŸ›¡ï¸ <b>Xavf darajasi:</b> "
            
            if severity == "Critical":
                result_text += "ğŸ”´ <b>CRITICAL</b>\n"
                result_text += "âŒ <b>BU XABARGA ISHONMANG!</b>\n"
                result_text += "â€¢ Havolaga bosmang\nâ€¢ Ma'lumot bermang\nâ€¢ Bloklang"
            elif severity == "High":
                result_text += "ğŸŸ  <b>HIGH</b>\n"
                result_text += "âš ï¸ <b>EHTIYOT BO'LING!</b>\n"
                result_text += "â€¢ Havolaga faqat ishonchli manzillarda bosing\nâ€¢ Ma'lumot bermang"
            elif severity == "Medium":
                result_text += "ğŸŸ¡ <b>MEDIUM</b>\n"
                result_text += "ğŸ”¶ <b>DIQQATLI BO'LING</b>\n"
                result_text += "â€¢ Havolani tekshiring\nâ€¢ Noma'lum manbalarga ishonmang"
            else:
                result_text += "ğŸŸ¢ <b>SAFE</b>\n"
            
            # Tugmalar
            keyboard_buttons = []
            if urls:
                keyboard_buttons.append(
                    [InlineKeyboardButton(text="ğŸ”— URL ni skanerlash", callback_data=f"scanurl_{hash(urls[0]) % 10000}")]
                )
            
            keyboard_buttons.append([
                InlineKeyboardButton(text="ğŸ“Š Batafsil ma'lumot", callback_data=f"detail_{hash(text) % 10000}"),
                InlineKeyboardButton(text="ğŸš¨ Shikoyat qilish", callback_data=f"report_{message.from_user.id}")
            ])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
        else:
            result_text = "âœ… <b>XAVFSIZ</b>\n\nBu matnda xavf topilmadi."
            keyboard = None
        
        await loading_msg.delete()
        await message.answer(result_text, reply_markup=keyboard)
        
        # Log qilish
        user_id = message.from_user.id
        chat_id = message.chat.id if message.chat.type != "private" else None
        
        if chat_id:
            db.add_group(chat_id, message.chat.title)
        
        db.log_message(chat_id, user_id, text[:100], severity)
        
    except Exception as e:
        await loading_msg.delete()
        await message.answer(f"âŒ Tahlil jarayonida xato: {str(e)[:100]}")

# ================ URL SKANERLASH ================
@dp.message(Command("scanurl"))
async def scanurl_cmd(message: types.Message):
    text = message.text.replace("/scanurl", "").strip()
    
    if not text:
        await message.answer("âŒ URL kiriting: <code>/scanurl [havola]</code>")
        return
    
    if not text.startswith(("http://", "https://")):
        text = "https://" + text
    
    await process_url_scan(message, text)

async def process_url_scan(message: types.Message, url: str):
    loading_msg = await message.answer(f"ğŸ” <b>URL skanerlanyapti...</b>\n\n<code>{url[:50]}</code>")
    
    try:
        results = await url_scanner.check_url_multiple_sources(url)
        
        response = f"ğŸ”— <b>URL Tahlili:</b>\n<code>{url[:100]}</code>\n\n"
        
        threats = []
        warnings = []
        
        for i, result in enumerate(results, 1):
            check_name = result.get("check", "Noma'lum")
            
            if result.get("suspicious"):
                details = result.get("details", {})
                
                if "free_domain" in details and details["free_domain"]:
                    threats.append(f"â€¢ Bepul domen (xavfli)")
                    warnings.append("Bepul domenlar odatda phishing uchun ishlatiladi")
                
                if "open_ports" in details and details["open_ports"]:
                    threats.append(f"â€¢ Ochiq portlar: {details['open_ports']}")
                    warnings.append("Ochiq portlar xavfsizlik muammosi bo'lishi mumkin")
                
                if "ssl_error" in details:
                    threats.append(f"â€¢ SSL muammosi")
                    warnings.append("SSL sertifikati xatosi")
                
                if "shortened" in details and details["shortened"]:
                    threats.append(f"â€¢ Qisqartirilgan URL ({details.get('service', 'Noma\'lum')})")
                    warnings.append("Qisqartirilgan URL lar maqsadini yashirishi mumkin")
        
        if threats:
            response += "âš ï¸ <b>XAVFLAR ANIQLANDI:</b>\n"
            for threat in threats:
                response += f"{threat}\n"
            
            response += "\nâŒ <b>BU HAVOLAGA BOSMANG!</b>\n\n"
            
            if warnings:
                response += "<b>Ogohlantirishlar:</b>\n"
                for warning in warnings[:3]:
                    response += f"â€¢ {warning}\n"
            
            severity = "High"
        else:
            response += "âœ… <b>XAVFSIZ</b>\n\nBu havola xavfli emas."
            severity = "Safe"
        
        await loading_msg.delete()
        
        # Tugmalar
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸŒ Browserda ochish", url=url)],
            [InlineKeyboardButton(text="ğŸ“Š Batafsil tahlil", callback_data=f"urldetail_{hash(url) % 10000}"),
             InlineKeyboardButton(text="ğŸ”„ Qayta tekshirish", callback_data=f"rescan_{hash(url) % 10000}")]
        ])
        
        await message.answer(response, reply_markup=keyboard, disable_web_page_preview=True)
        
        # Log qilish
        db.log_message(
            message.chat.id if message.chat.type != "private" else None,
            message.from_user.id,
            f"[URL SCAN] {url[:50]}",
            severity
        )
            
    except Exception as e:
        await loading_msg.delete()
        await message.answer(f"âŒ URL skanerlashda xato: {str(e)[:100]}")

# ================ FOYDALANUVCHI BUYRUQLARI ================
@dp.message(F.text == "ğŸ“Š Mening statistikam")
@dp.message(Command("mystats"))
async def mystats_cmd(message: types.Message):
    user_id = message.from_user.id
    
    try:
        user_stats = db.get_user_stats(user_id)
        
        if user_stats:
            total = user_stats.get('total_messages', 0)
            threats = user_stats.get('threat_messages', 0)
            safe = total - threats
            trust_score = user_stats.get('trust_score', 100)
            username = user_stats.get('username')
            full_name = user_stats.get('full_name')
            last_activity = user_stats.get('last_activity')
            
            response = (
                f"ğŸ“Š <b>Sizning statistikangiz</b>\n\n"
                f"ğŸ‘¤ <b>Ma'lumotlar:</b>\n"
                f"   ğŸ“› Ism: {full_name or 'Noma\'lum'}\n"
                f"   ğŸ“§ Username: @{username or 'Yo\'q'}\n"
                f"   â­ Ishonch: {trust_score}/100\n\n"
                
                f"ğŸ“¨ <b>Faollik:</b>\n"
                f"   Jami xabarlar: {total}\n"
                f"   âœ… Xavfsiz: {safe}\n"
                f"   ğŸš¨ Xavfli: {threats}\n"
                f"   ğŸ›¡ï¸ Xavfsizlik: {(safe/total*100 if total else 100):.1f}%\n"
                f"   ğŸ“… So'nggi faollik: {format_time_difference(last_activity)}\n\n"
            )
            
            # O'qilmagan xabarlar soni
            unread_count = db.get_unread_messages_count(user_id, is_admin=False)
            if unread_count > 0:
                response += f"ğŸ“¨ <b>Sizda {unread_count} ta o'qilmagan xabar bor!</b>\n\n"
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="ğŸ”„ Yangilash", callback_data="refreshstats"),
                 InlineKeyboardButton(text="ğŸ“© Admin bilan bog'lanish", callback_data="start_support")],
                [InlineKeyboardButton(text="ğŸ” Tekshirish", callback_data="checknow"),
                 InlineKeyboardButton(text="ğŸ›¡ï¸ Xavfsizlik", callback_data="safety_tips")]
            ])
        else:
            response = "ğŸ“­ <b>Siz hali hech qanday xabar yubormagansiz</b>\n\n"
            keyboard = None
        
        await message.answer(response, reply_markup=keyboard)
        
    except Exception as e:
        await message.answer(f"âŒ Xato: {str(e)[:100]}")

@dp.message(F.text == "ğŸ›¡ï¸ Xavfsizlik tavsiyalari")
async def safety_tips_cmd(message: types.Message):
    """Xavfsizlik tavsiyalari"""
    tips = (
        "ğŸ›¡ï¸ <b>Kiberxavfsizlik Tavsiyalari</b>\n\n"
        
        "ğŸ”’ <b>1. Parol xavfsizligi:</b>\n"
        "â€¢ Har bir hisob uchun alohida parol\n"
        "â€¢ Kamida 12 ta belgi (harflar, raqamlar, belgilar)\n"
        "â€¢ 2-bosqichli autentifikatsiyani yoqing\n\n"
        
        "ğŸŒ <b>2. Internet xavfsizligi:</b>\n"
        "â€¢ Faqat HTTPS saytlardan foydalaning\n"
        "â€¢ VPN dan foydalaning (ayniqsa ochiq WiFi da)\n"
        "â€¢ Brauzeringizni yangilang\n"
        "â€¢ Ad-blocker o'rnating\n\n"
        
        "ğŸ“§ <b>3. Email xavfsizligi:</b>\n"
        "â€¢ Noma'lum manbalardan kelgan fayllarni ochmang\n"
        "â€¢ Phishing xabarlariga javob bermang\n"
        "â€¢ SPAM ga o'tkazishni o'rganing\n\n"
        
        "ğŸ“± <b>4. Telegram xavfsizligi:</b>\n"
        "â€¢ Noma'lum botlarga ma'lumot bermang\n"
        "â€¢ Guruhlarda shubhali fayllarni ochmang\n"
        "â€¢ Maxfiylik sozlamalarini tekshiring\n"
        "â€¢ Admin da'vosidagilarga ishonmaslik\n\n"
        
        "ğŸ’³ <b>5. Moliyaviy xavfsizlik:</b>\n"
        "â€¢ Onlayn to'lovlarda faqat ishonchli saytlar\n"
        "â€¢ Karta ma'lumotlarini hech kimga bermang\n"
        "â€¢ SMS orqali kelgan kodlarni maxfiylashtiring\n\n"
        
        "<i>Xavfsizlik - bu odat, bir marotiba emas!</i>"
    )
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ” Hozir tekshirish", callback_data="checknow")],
        [InlineKeyboardButton(text="ğŸ“Š Mening statistikam", callback_data="mystats"),
         InlineKeyboardButton(text="ğŸ“š Qo'llanma", callback_data="help")]
    ])
    
    await message.answer(tips, reply_markup=keyboard)

# ================ ADMIN BUYRUQLARI ================
@dp.message(F.text == "ğŸ‘¥ Foydalanuvchilar")
@dp.message(Command("users"))
async def users_cmd(message: types.Message):
    if not is_admin(message.from_user.id):
        await message.answer("âŒ Siz admin emassiz!")
        return
    
    try:
        parts = message.text.split()
        page = 1
        search = None
        
        if len(parts) > 1:
            if parts[1].isdigit():
                page = int(parts[1])
            else:
                search = parts[1]
        
        users_per_page = 10
        offset = (page - 1) * users_per_page
        
        if search:
            users = db.cursor.execute('''
                SELECT u.user_id, u.username, u.full_name, u.trust_score,
                       COUNT(l.id) as message_count,
                       SUM(CASE WHEN l.threat_level != 'Safe' THEN 1 ELSE 0 END) as threat_count
                FROM users u
                LEFT JOIN logs l ON u.user_id = l.user_id
                WHERE u.username LIKE ? OR u.full_name LIKE ? OR u.user_id = ?
                GROUP BY u.user_id
                ORDER BY u.user_id
                LIMIT ? OFFSET ?
            ''', (f"%{search}%", f"%{search}%", search if search.isdigit() else -1, users_per_page, offset)).fetchall()
        else:
            users = db.cursor.execute('''
                SELECT u.user_id, u.username, u.full_name, u.trust_score,
                       COUNT(l.id) as message_count,
                       SUM(CASE WHEN l.threat_level != 'Safe' THEN 1 ELSE 0 END) as threat_count
                FROM users u
                LEFT JOIN logs l ON u.user_id = l.user_id
                GROUP BY u.user_id
                ORDER BY u.user_id
                LIMIT ? OFFSET ?
            ''', (users_per_page, offset)).fetchall()
        
        if not users:
            await message.answer("ğŸ“­ Foydalanuvchilar topilmadi")
            return
        
        response = f"ğŸ‘¥ <b>Foydalanuvchilar</b>"
        if search:
            response += f" (Qidiruv: {search})"
        response += f"\nSahifa {page}\n\n"
        
        for user in users:
            user_id, username, full_name, trust_score, msg_count, threat_count = user
            
            user_link = f'<a href="tg://user?id={user_id}">{full_name or "Noma\'lum"}</a>'
            username_display = f"@{username}" if username else "Yo'q"
            
            if trust_score >= 80:
                trust_emoji = "ğŸŸ¢"
                trust_text = "Yuqori"
            elif trust_score >= 50:
                trust_emoji = "ğŸŸ¡"
                trust_text = "O'rtacha"
            else:
                trust_emoji = "ğŸ”´"
                trust_text = "Past"
            
            response += (
                f"{trust_emoji} <b>{user_link}</b>\n"
                f"   ğŸ†” ID: <code>{user_id}</code>\n"
                f"   ğŸ“› {username_display}\n"
                f"   ğŸ“Š Xabarlar: {msg_count}\n"
                f"   ğŸš¨ Xavflar: {threat_count}\n"
                f"   â­ Ishonch: {trust_score}/100 ({trust_text})\n"
                f"{'-'*35}\n"
            )
        
        # Sahifa ma'lumotlari
        if search:
            total_users = db.cursor.execute('''
                SELECT COUNT(*) FROM users 
                WHERE username LIKE ? OR full_name LIKE ? OR user_id = ?
            ''', (f"%{search}%", f"%{search}%", search if search.isdigit() else -1)).fetchone()[0]
        else:
            total_users = db.cursor.execute("SELECT COUNT(*) FROM users").fetchone()[0]
        
        total_pages = (total_users + users_per_page - 1) // users_per_page
        
        response += f"\nğŸ“„ <b>Sahifa {page}/{total_pages}</b> | Jami: {total_users} foydalanuvchi"
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="â¬…ï¸ Oldingi", callback_data=f"users_{page-1}_{search or ''}") if page > 1 else InlineKeyboardButton(text="â€¢", callback_data="none"),
                InlineKeyboardButton(text=f"{page}/{total_pages}", callback_data="none"),
                InlineKeyboardButton(text="Keyingi â¡ï¸", callback_data=f"users_{page+1}_{search or ''}") if page < total_pages else InlineKeyboardButton(text="â€¢", callback_data="none")
            ]
        ])
        
        await message.answer(response, reply_markup=keyboard)
        
    except Exception as e:
        await message.answer(f"âŒ Xato: {str(e)[:200]}")

@dp.message(F.text == "ğŸ“ˆ Statistika")
@dp.message(Command("stats"))
async def stats_cmd(message: types.Message):
    """Umumiy statistika"""
    if not is_admin(message.from_user.id):
        await message.answer("âŒ Siz admin emassiz!")
        return
    
    try:
        users, groups, threats = db.get_stats()
        
        # Qo'shimcha statistikalar
        today_stats = db.cursor.execute('''
            SELECT 
                COUNT(DISTINCT user_id) as active_today,
                COUNT(*) as messages_today,
                SUM(CASE WHEN threat_level != 'Safe' THEN 1 ELSE 0 END) as threats_today
            FROM logs 
            WHERE DATE(created_at) = DATE('now')
        ''').fetchone()
        active_today, msgs_today, threats_today = today_stats or (0, 0, 0)
        
        stats_text = (
            f"ğŸ“Š <b>Umumiy statistika</b>\n"
            f"ğŸ• {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
            
            f"ğŸ‘¥ <b>Asosiy ko'rsatkichlar:</b>\n"
            f"   ğŸ‘¤ Foydalanuvchilar: {users} ta\n"
            f"   ğŸ‘¥ Guruhlar: {groups} ta\n"
            f"   ğŸš¨ Aniqlangan xavflar: {threats} ta\n\n"
            
            f"ğŸ“… <b>Bugungi kun:</b>\n"
            f"   ğŸ‘¤ Faol foydalanuvchilar: {active_today}\n"
            f"   ğŸ“¨ Xabarlar: {msgs_today}\n"
            f"   âš ï¸ Xavflar: {threats_today}\n"
        )
        
        await message.answer(stats_text)
        
    except Exception as e:
        await message.answer(f"âŒ Xato: {str(e)[:200]}")

# ================ ADMIN SUPPORT JAVOBLARI ================
@dp.message(Command("support"))
async def support_admin_cmd(message: types.Message):
    """Admin uchun support so'rovlarini ko'rish va javob berish"""
    if not is_admin(message.from_user.id):
        await message.answer("âŒ Siz admin emassiz!")
        return
    
    try:
        parts = message.text.split()
        
        if len(parts) > 1:
            # Aniq bir so'rovga javob berish
            if parts[1].isdigit():
                request_id = int(parts[1])
                
                # So'rovni olish
                request = db.get_support_request(request_id)
                if not request:
                    await message.answer(f"âŒ #{request_id} ID li so'rov topilmadi")
                    return
                
                # Admin holatini saqlash
                db.cursor.execute('''INSERT OR REPLACE INTO user_states 
                                  (user_id, state, data) VALUES (?, ?, ?)''',
                                  (message.from_user.id, 'admin_reply', 
                                   json.dumps({'request_id': request_id, 'target_user': request['user_id']})))
                db.conn.commit()
                
                # Conversation ni olish
                conversation = db.get_support_conversation(request_id)
                
                response = (
                    f"ğŸ“¨ <b>Support So'rovi #{request_id}</b>\n"
                    f"ğŸ‘¤ Foydalanuvchi: <a href='tg://user?id={request['user_id']}'>{request['full_name']}</a>\n"
                    f"ğŸ“Œ Mavzu: {request['subject']}\n"
                    f"ğŸ“Š Holat: {request['status']}\n\n"
                    f"<b>Conversation:</b>\n"
                )
                
                for msg in conversation[-5:]:  # Oxirgi 5 xabarni ko'rsatish
                    sender = f"ğŸ‘¤ {msg['full_name']}" if msg['is_from_user'] else f"ğŸ‘® Admin"
                    time = msg['created_at'].split()[1][:5] if msg['created_at'] else ""
                    response += f"<i>{time}</i> {sender}: {msg['message_text']}\n\n"
                
                response += f"\nğŸ“ <b>Javobingizni yozing...</b>"
                
                await message.answer(response, reply_markup=ReplyKeyboardRemove())
                return
            
            elif parts[1] == "list":
                # Barcha ochiq so'rovlarni ko'rsatish
                await show_support_requests(message)
                return
        
        # Default: ochiq so'rovlarni ko'rsatish
        await show_support_requests(message)
        
    except Exception as e:
        await message.answer(f"âŒ Xato: {str(e)[:200]}")

async def show_support_requests(message: types.Message):
    """Ochiq support so'rovlarini ko'rsatish"""
    try:
        requests = db.get_support_requests(status='pending')
        
        if not requests:
            await message.answer("âœ… Hozircha ochiq support so'rovlari yo'q")
            return
        
        response = f"ğŸ“¨ <b>Ochiq Support So'rovlari ({len(requests)} ta)</b>\n\n"
        
        for i, req in enumerate(requests, 1):
            user_link = f"<a href='tg://user?id={req['user_id']}'>{req['full_name']}</a>"
            username_display = f"@{req['username']}" if req['username'] else "Yo'q"
            
            response += (
                f"{i}. <b>#{req['id']}</b> - {req['subject']}\n"
                f"   ğŸ‘¤ {user_link} ({username_display})\n"
                f"   ğŸ“ {req['last_message'][:60]}...\n"
                f"   â° {format_time_difference(req['created_at'])}\n"
                f"{'-'*30}\n"
            )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”„ Yangilash", callback_data="refresh_support")],
            [InlineKeyboardButton(text="ğŸ“‹ Barcha so'rovlar", callback_data="all_requests")]
        ])
        
        await message.answer(response, reply_markup=keyboard)
        
    except Exception as e:
        await message.answer(f"âŒ Xato: {str(e)[:200]}")

@dp.message(F.text == "ğŸ“¨ Support")
async def support_button_cmd(message: types.Message):
    """Support tugmasi uchun handler"""
    if not is_admin(message.from_user.id):
        await message.answer("âŒ Siz admin emassiz!")
        return
    
    await show_support_requests(message)

# ================ ADMIN BILAN BOG'LANISH ================
@dp.message(F.text == "ğŸ“© Admin bilan bog'lanish")
async def contact_admin_cmd(message: types.Message):
    await message.answer(
        "ğŸ“¨ <b>Admin bilan bog'lanish</b>\n\n"
        "Xabaringiz mavzusini kiriting:\n\n"
        "<i>Misol: Hisobni tiklash, Xavfli xabar haqida, Bot bilan muammo</i>",
        reply_markup=ReplyKeyboardRemove()
    )
    
    # Foydalanuvchi holatini saqlash
    db.cursor.execute('''INSERT OR REPLACE INTO user_states 
                      (user_id, state, data) VALUES (?, ?, ?)''',
                      (message.from_user.id, 'awaiting_subject', json.dumps({})))
    db.conn.commit()

# ================ GURUH XABARLARI ================
@dp.message(F.text)
async def handle_all_messages(message: types.Message):
    # Admin bo'lsa
    if is_admin(message.from_user.id):
        await handle_admin_message(message)
        return
    
    # Foydalanuvchi holatini tekshirish
    result = db.cursor.execute('''SELECT state, data FROM user_states WHERE user_id = ?''',
                              (message.from_user.id,)).fetchone()
    
    if result:
        state, data_json = result
        state_data = json.loads(data_json) if data_json else {}
        
        if state == 'awaiting_subject':
            # Mavzuni qabul qilish
            subject = message.text[:100]
            
            db.cursor.execute('''UPDATE user_states SET 
                              state = 'awaiting_message', 
                              data = ? WHERE user_id = ?''',
                              (json.dumps({'subject': subject}), message.from_user.id))
            db.conn.commit()
            
            await message.answer(
                f"ğŸ“ <b>Mavzu:</b> {subject}\n\n"
                f"Endi xabaringizni yuboring:\n\n"
                f"<i>Xabaringizni batafsil yozing. Admin tez orada javob beradi.</i>"
            )
        
        elif state == 'awaiting_message':
            # Xabarni qabul qilish
            subject = state_data.get('subject', 'Noma\'lum')
            message_text = message.text
            
            request_id = db.create_support_request(
                message.from_user.id,
                subject,
                message_text
            )
            
            if request_id:
                db.cursor.execute('''DELETE FROM user_states WHERE user_id = ?''',
                                (message.from_user.id,))
                db.conn.commit()
                
                await message.answer(
                    f"âœ… <b>Xabaringiz qabul qilindi!</b>\n\n"
                    f"ğŸ“Œ <b>Mavzu:</b> {subject}\n"
                    f"ğŸ“ <b>So'rovingiz:</b> {message_text[:100]}...\n"
                    f"ğŸ†” <b>ID:</b> #{request_id}\n\n"
                    f"<i>Admin tez orada javob beradi.</i>",
                    reply_markup=get_main_keyboard(message.from_user.id)
                )
                
                # Adminlarga bildirish
                for admin_id in ADMIN_IDS:
                    try:
                        user_link = get_user_link(message.from_user)
                        await bot.send_message(
                            admin_id,
                            f"ğŸ“¨ <b>Yangi Support So'rovi!</b>\n\n"
                            f"ğŸ†” ID: #{request_id}\n"
                            f"ğŸ‘¤ {user_link}\n"
                            f"ğŸ“Œ Mavzu: {subject}\n"
                            f"ğŸ“ Xabar: {message_text[:200]}...\n\n"
                            f"<i>Javob berish uchun: /support {request_id}</i>"
                        )
                        print(f"âœ… Admin {admin_id} ga bildirish yuborildi")
                    except Exception as e:
                        print(f"âŒ Admin {admin_id} ga yuborish xatosi: {e}")
            else:
                await message.answer(
                    "âŒ Xabar yuborishda xatolik yuz berdi. Iltimos, qayta urinib ko'ring.",
                    reply_markup=get_main_keyboard(message.from_user.id)
                )
    else:
        # Guruhda avtomatik tekshirish
        if message.chat.type in ["group", "supergroup"]:
            await handle_group_message(message)
        else:
            # Shaxsiy chatda tekshirish taklifi
            await message.answer(
                "ğŸ¤– <b>Kiber-Inspektor</b> sizning xabaringizni avtomatik tekshirishni taklif qiladi.\n\n"
                "Xavfsizlikni ta'minlash uchun quyidagi tugmalardan foydalaning:",
                reply_markup=get_main_keyboard(message.from_user.id)
            )

async def handle_admin_message(message: types.Message):
    """Admin xabarlarini qayta ishlash"""
    # Admin holatini tekshirish
    result = db.cursor.execute('''SELECT state, data FROM user_states WHERE user_id = ?''',
                              (message.from_user.id,)).fetchone()
    
    if result:
        state, data_json = result
        state_data = json.loads(data_json) if data_json else {}
        
        if state == 'admin_reply':
            # Admin javobini qabul qilish
            request_id = state_data.get('request_id')
            target_user = state_data.get('target_user')
            reply_text = message.text
            
            if request_id and target_user:
                # Conversation ga javob qo'shish
                if db.add_support_message(request_id, message.from_user.id, reply_text, is_from_user=False):
                    # Request statusini yangilash
                    db.update_support_request(request_id, 'answered', reply_text)
                    
                    # Holatni tozalash
                    db.cursor.execute('''DELETE FROM user_states WHERE user_id = ?''',
                                    (message.from_user.id,))
                    db.conn.commit()
                    
                    # Foydalanuvchiga javob yuborish
                    try:
                        await bot.send_message(
                            target_user,
                            f"ğŸ“¨ <b>Admin javobi (So'rov #{request_id}):</b>\n\n{reply_text}\n\n"
                            f"<i>Qo'shimcha savollaringiz bo'lsa, yana yozing.</i>",
                            reply_markup=get_main_keyboard(target_user)
                        )
                        
                        await message.answer(
                            f"âœ… <b>Javob yuborildi!</b>\n\n"
                            f"ğŸ‘¤ Foydalanuvchi: {target_user}\n"
                            f"ğŸ“ Javob: {reply_text[:100]}...",
                            reply_markup=get_admin_keyboard()
                        )
                    except Exception as e:
                        await message.answer(
                            f"âŒ Foydalanuvchiga javob yuborishda xato: {e}",
                            reply_markup=get_admin_keyboard()
                        )
                else:
                    await message.answer("âŒ Javob yuborishda xatolik")
            else:
                await message.answer("âŒ Ma'lumotlar topilmadi")
        else:
            # Oddiy admin xabari
            await message.answer(
                "ğŸ¤– <b>Admin paneli</b>\n\n"
                "Foydalanuvchilarga javob berish uchun:\n"
                "1. /support list - barcha so'rovlarni ko'rish\n"
                "2. /support [ID] - aniq so'rovga javob berish\n\n"
                "Boshqa admin buyruqlari: /users, /stats, /report",
                reply_markup=get_admin_keyboard()
            )
    else:
        # Oddiy admin xabari
        await message.answer(
            "ğŸ¤– <b>Admin paneli</b>\n\n"
            "Foydalanuvchilarga javob berish uchun:\n"
            "1. /support list - barcha so'rovlarni ko'rish\n"
            "2. /support [ID] - aniq so'rovga javob berish\n\n"
            "Boshqa admin buyruqlari: /users, /stats, /report",
            reply_markup=get_admin_keyboard()
        )

# ================ FAYL TAHLLILI ================
@dp.message(F.document | F.photo | F.video | F.audio)
async def handle_files(message: types.Message):
    """Fayllarni qayta ishlash"""
    
    print(f"DEBUG: Fayl qabul qilindi - {message.content_type}")
    
    # Guruhda bo'lsa
    if message.chat.type in ["group", "supergroup"]:
        await analyze_group_file(message)
    else:
        # Shaxsiy chatda
        await analyze_private_file(message)

async def analyze_group_file(message: types.Message):
    """Guruhdagi faylni tahlil qilish"""
    try:
        if message.document:
            file_name = message.document.file_name
            file_size = message.document.file_size
            mime_type = message.document.mime_type
            
            print(f"DEBUG: Fayl: {file_name}, Hajm: {file_size}, MIME: {mime_type}")
            
            # Tahlil natijasini olish
            analysis_result = await file_analyzer.analyze_telegram_file(
                file_name, file_size, mime_type
            )
            
            verdict = analysis_result.get("verdict", "Safe")
            risk_level = analysis_result.get("risk_level", "Low")
            warnings = analysis_result.get("warnings", [])
            
            # Agar xavfli bo'lsa
            if verdict in ["Malicious", "Suspicious"]:
                user_link = get_user_link(message.from_user)
                
                alert = f"âš ï¸ <b>XAVFLI FAYL ANIQLANDI!</b>\n\n"
                alert += f"ğŸ‘¤ {user_link}\n"
                alert += f"ğŸ“ <code>{file_name}</code>\n"
                alert += f"ğŸ“Š Hajm: {file_size/(1024*1024):.2f} MB\n"
                alert += f"ğŸ›¡ï¸ Xavf darajasi: {risk_level}\n"
                alert += f"ğŸ“‹ Natija: {verdict}\n\n"
                
                if warnings:
                    alert += "ğŸ”´ <b>Ogohlantirishlar:</b>\n"
                    for i, warning in enumerate(warnings[:3], 1):
                        alert += f"{i}. {warning}\n"
                    alert += "\n"
                
                alert += "âŒ <b>BU FAYLNI OCHMANG!</b>\n"
                alert += "â€¢ Faylni yuklamang\nâ€¢ Faylni ochmang\nâ€¢ Administratorlarga xabar bering"
                
                await message.reply(alert)
                
                # Log qilish
                db.add_user(message.from_user.id, message.from_user.username, message.from_user.full_name)
                db.add_group(message.chat.id, message.chat.title)
                db.log_message(
                    message.chat.id,
                    message.from_user.id,
                    f"[FILE] {file_name[:50]}",
                    "Critical" if verdict == "Malicious" else "High"
                )
            else:
                # Xavfsiz fayl, faqat log qilish
                db.add_user(message.from_user.id, message.from_user.username, message.from_user.full_name)
                db.add_group(message.chat.id, message.chat.title)
                db.log_message(
                    message.chat.id,
                    message.from_user.id,
                    f"[FILE] {file_name[:50]}",
                    "Safe"
                )
    
    except Exception as e:
        print(f"âŒ Fayl tahlilida xato: {e}")

async def analyze_private_file(message: types.Message):
    """Shaxsiy chatdagi faylni tahlil qilish"""
    try:
        if message.document:
            file_name = message.document.file_name
            file_size = message.document.file_size
            
            loading_msg = await message.answer("ğŸ” <b>Fayl tahlil qilinmoqda...</b>")
            
            # Tahlil natijasini olish
            analysis_result = await file_analyzer.analyze_telegram_file(
                file_name, file_size, message.document.mime_type
            )
            
            # Natija xabarini tayyorlash
            response = file_analyzer.get_file_verdict_message(analysis_result)
            
            await loading_msg.delete()
            await message.answer(response)
            
    except Exception as e:
        print(f"âŒ Shaxsiy fayl tahlilida xato: {e}")
        
async def handle_group_message(message: types.Message):
    text = message.text
    
    # Tahlil qilish
    threat1, severity = analyze_message(text)
    threats2, severity2 = analyze_message_advanced(text)
    
    # URL tekshirish
    urls = re.findall(r'https?://[^\s]+', text.lower())
    url_threats = []
    
    bad_domains = ['.tk', '.ml', '.ga', '.cf', '.gq', '.xyz', '.top', '.club', '.shop', '.online']
    for url in urls[:2]:
        for domain in bad_domains:
            if domain in url:
                url_threats.append("Phishing havolasi")
                severity = "High" if severity != "Critical" else "Critical"
                break
    
    # Barcha tahdidlarni birlashtirish
    all_threats = []
    if threat1: 
        all_threats.append(threat1)
    if url_threats: 
        all_threats.extend(url_threats)
    if threats2: 
        all_threats.extend(threats2)
    
    # AI tahlil
    is_scam, probability = ai_analyzer.predict(text)
    if is_scam and probability > 0.7:
        all_threats.append(f"AI: Scam ehtimoli {probability:.0%}")
        severity = "High" if severity not in ["Critical", "High"] else severity
    
    # Agar tahdid bo'lsa
    if all_threats:
        user_link = get_user_link(message.from_user)
        
        if severity == "Critical":
            emoji = "ğŸ”´"
            title = "CRITICAL XAVF!"
        elif severity == "High":
            emoji = "ğŸŸ "
            title = "YUQORI XAVF!"
        elif severity == "Medium":
            emoji = "ğŸŸ¡"
            title = "O'RTACHA XAVF"
        else:
            emoji = "âšª"
            title = "XAVF"
        
        alert = f"{emoji} <b>{title}</b>\n\n"
        alert += f"ğŸ‘¤ {user_link}\n"
        alert += f"ğŸ“› {all_threats[0]}\n"
        
        if len(all_threats) > 1:
            alert += f"ğŸ“Š {len(all_threats)-1} ta qo'shimcha xavf\n"
        
        alert += f"ğŸ›¡ï¸ <b>{severity}</b> daraja\n\n"
        
        if severity == "Critical":
            alert += "âŒ <b>BU XABARGA ISHONMANG!</b>\n"
            alert += "â€¢ Havolaga bosmang\nâ€¢ Ma'lumot bermang\nâ€¢ Foydalanuvchini bloklang"
        elif severity == "High":
            alert += "âš ï¸ <b>EHTIYOT BO'LING!</b>\n"
            alert += "â€¢ Havolaga faqat ishonchli manzillarda bosing\nâ€¢ Shaxsiy ma'lumot bermang"
        elif severity == "Medium":
            alert += "ğŸ”¶ <b>DIQQATLI BO'LING</b>\n"
            alert += "â€¢ Havolani tekshiring\nâ€¢ Noma'lum manbalarga ishonmang"
        
        await message.reply(alert)
        
        # Log qilish
        db.add_user(message.from_user.id, message.from_user.username, message.from_user.full_name)
        db.add_group(message.chat.id, message.chat.title)
        db.log_message(message.chat.id, message.from_user.id, text[:100], severity)
    
    # Agar xavf bo'lmasa, faqat log qilish
    elif message.chat.type in ["group", "supergroup"]:
        db.add_user(message.from_user.id, message.from_user.username, message.from_user.full_name)
        db.add_group(message.chat.id, message.chat.title)
        db.log_message(message.chat.id, message.from_user.id, text[:100], "Safe")

# ================ CALLBACK QUERY HANDLERLAR ================
@dp.callback_query()
async def handle_callback(callback: CallbackQuery):
    """Callback query larini qayta ishlash"""
    data = callback.data
    
    try:
        if data == "none":
            await callback.answer()
            return
        
        if data.startswith("users_"):
            # Foydalanuvchilar sahifasi
            await callback.answer("Yuklanmoqda...")
            
            parts = data.split("_")
            page = int(parts[1]) if len(parts) > 1 and parts[1].isdigit() else 1
            search = parts[2] if len(parts) > 2 else ""
            
            text = f"/users {page}"
            if search:
                text += f" {search}"
            
            # Message obyektini yaratish
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text=text
            )
            
            await users_cmd(message_obj)
        
        elif data == "refreshstats":
            # Statistika yangilash
            await callback.answer("Yangilanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="/stats"
            )
            
            await stats_cmd(message_obj)
        
        elif data == "checknow":
            # Tekshirish
            await callback.answer("Tekshirish boshlandi")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="ğŸ” Tekshirish"
            )
            
            await check_cmd(message_obj)
        
        elif data == "mystats":
            # Shaxsiy statistika
            await callback.answer("Yuklanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="/mystats"
            )
            
            await mystats_cmd(message_obj)
        
        elif data == "safety_tips":
            # Xavfsizlik tavsiyalari
            await callback.answer("Yuklanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="ğŸ›¡ï¸ Xavfsizlik tavsiyalari"
            )
            
            await safety_tips_cmd(message_obj)
        
        elif data == "help":
            # Yordam
            await callback.answer("Yuklanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="/help"
            )
            
            await help_cmd(message_obj)
        
        elif data == "start_support":
            # Admin bilan bog'lanish
            await callback.answer("Support boshlandi...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="ğŸ“© Admin bilan bog'lanish"
            )
            
            await contact_admin_cmd(message_obj)
        
        elif data == "start_check":
            # Tekshirishni boshlash
            await callback.answer("Boshlanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="ğŸ” Tekshirish"
            )
            
            await check_cmd(message_obj)
        
        elif data == "refresh_support":
            # Support so'rovlarini yangilash
            await callback.answer("Yangilanmoqda...")
            
            message_obj = Message(
                message_id=callback.message.message_id,
                date=callback.message.date,
                chat=callback.message.chat,
                from_user=callback.from_user,
                text="/support list"
            )
            
            await support_admin_cmd(message_obj)
        
        elif data == "all_requests":
            # Barcha support so'rovlari
            await callback.answer("Yuklanmoqda...")
            
            try:
                requests = db.get_support_requests()  # status bermasak, hammasini oladi
                
                if not requests:
                    await callback.answer("Hech qanday so'rov topilmadi", show_alert=True)
                    return
                
                response = f"ğŸ“¨ <b>Barcha Support So'rovlari ({len(requests)} ta)</b>\n\n"
                
                for i, req in enumerate(requests, 1):
                    status_emoji = {
                        'pending': 'ğŸŸ¡',
                        'answered': 'ğŸŸ¢',
                        'closed': 'ğŸ”´'
                    }.get(req['status'], 'âšª')
                    
                    user_link = f"<a href='tg://user?id={req['user_id']}'>{req['full_name']}</a>"
                    
                    response += (
                        f"{status_emoji} <b>#{req['id']}</b> - {req['subject']}\n"
                        f"   ğŸ‘¤ {user_link}\n"
                        f"   ğŸ“Š Holat: {req['status']}\n"
                        f"   â° {format_time_difference(req['created_at'])}\n"
                        f"{'-'*25}\n"
                    )
                
                # InlineKeyboard bilan
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="â¬…ï¸ Orqaga", callback_data="refresh_support")]
                ])
                
                await callback.message.edit_text(response, parse_mode='HTML', reply_markup=keyboard)
                
            except Exception as e:
                await callback.answer(f"Xato: {str(e)[:50]}", show_alert=True)
        
        else:
            # Noma'lum callback
            await callback.answer(f"Tugma ishladi")
        
    except Exception as e:
        await callback.answer(f"Xato: {str(e)[:50]}", show_alert=True)

# ================ MENYU TUGMALARI ================
@dp.message(F.text == "â¬…ï¸ Asosiy menyu")
async def main_menu_cmd(message: Message):
    """Asosiy menyuga qaytish"""
    await message.answer(
        "ğŸ›¡ï¸ <b>Asosiy menyu</b>\n\n"
        "Quyidagi tugmalardan birini tanlang:",
        reply_markup=get_main_keyboard(message.from_user.id)
    )

# ================ BOTNI ISHGA TUSHIRISH ================
async def main():
    """Asosiy funksiya"""
    print("=" * 50)
    print("ğŸ›¡ï¸  KIBER-INSPEKTOR BOTI")
    print("=" * 50)
    
    try:
        bot_info = await bot.get_me()
        print(f"ğŸ¤– Bot: @{bot_info.username}")
        print(f"ğŸ‘® Adminlar: {ADMIN_IDS}")
        print(f"ğŸ’¾ DB: âœ…")
        print("=" * 50)
        print("\nğŸ“Š Bot faol...")
        print(f"DEBUG: Bot token mavjud: {'âœ…' if BOT_TOKEN else 'âŒ'}")
        print(f"DEBUG: Admin ID lar soni: {len(ADMIN_IDS)}")
    except Exception as e:
        print(f"âŒ Bot ma'lumotlarini olishda xato: {e}")
        return
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"âŒ Polling xatosi: {e}")
    finally:
        await bot.session.close()

if __name__ == "__main__":
    # Logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler('bot.log', encoding='utf-8'),
            logging.StreamHandler()
        ]
    )
    
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nğŸ›‘ Bot to'xtatildi.")
    except Exception as e:
        print(f"âŒ Kutilmagan xato: {e}") bu kod o'z xolicha qoladi, shunga asosan file_analyzer.py faylini yaxshilab ber.botning faylni analiz qilishini rivojlantirishimiz kerak. import magic
import hashlib
import json
from pathlib import Path
import aiohttp
import os
from typing import Dict, Optional, Tuple
import logging
from urllib.parse import urlparse

logger = logging.getLogger(__name__)

class AdvancedFileAnalyzer:
    def __init__(self):
        self.vt_client = None
        self.suspicious_keywords = [
            "crack", "keygen", "serial", "hack", "password", "free_",
            "patch", "loader", "activator", "torrent", "warez", "nulled",
            "mod", "premium", "pro", "unlocked", "hacked", "bypass"
        ]
        
        # Xavfli fayl turlari va ularning xavf darajasi
        self.dangerous_extensions = {
            # Executable files
            'exe': 10, 'bat': 9, 'cmd': 9, 'vbs': 9, 'js': 8,
            'scr': 9, 'pif': 9, 'com': 9, 'jar': 8, 'hta': 8,
            'msi': 7, 'dmg': 6, 'deb': 6, 'rpm': 6,
            
            # Android files (APK lar xavfli bo'lishi mumkin)
            'apk': 8, 'xapk': 8, 'apkm': 8, 'apks': 8,
            
            # Script files
            'py': 5, 'php': 5, 'sh': 6, 'bash': 6, 'ps1': 7,
            
            # Office macros
            'docm': 6, 'xlsm': 6, 'pptm': 6,
        }
        
        self.suspicious_extensions = {
            # Archive files (virus yashirish mumkin)
            'zip': 5, 'rar': 5, '7z': 5, 'tar': 4, 'gz': 4,
            'iso': 6, 'img': 6, 'vhd': 6, 'vmdk': 6,
            
            # Document files
            'doc': 3, 'docx': 3, 'pdf': 3, 'xls': 3, 'xlsx': 3,
        }
        
        # APK uchun maxsus so'zlar
        self.apk_suspicious_keywords = [
            "hack", "mod", "premium", "pro", "unlocked", "free",
            "cracked", "patched", "bypass", "cheat", "money",
            "infinite", "unlimited", "godmode", "noads"
        ]
        
        # Magic number lar
        self.file_signatures = {
            'exe': b'MZ',
            'zip': b'PK',
            'rar': b'Rar!\x1A\x07',
            'pdf': b'%PDF',
            'jpg': b'\xFF\xD8\xFF',
            'png': b'\x89PNG\r\n\x1A\n',
            'apk': b'PK',  # APK ham ZIP formatida
        }
    
    async def analyze_telegram_file(self, file_name: str, file_size: int, 
                                   mime_type: str = None) -> Dict:
        """Telegram faylini tahlil qilish (faylsiz)"""
        results = {
            "file_name": file_name,
            "file_size": file_size,
            "mime_type": mime_type or "unknown",
            "risk_level": "Low",
            "score": 0,
            "warnings": [],
            "verdict": "Safe",
            "details": {}
        }
        
        try:
            risk_score = 0
            warnings = []
            
            file_name_lower = file_name.lower()
            
            # 1. Fayl kengaytmasi tekshirish
            file_ext = self._get_file_extension(file_name_lower)
            results["details"]["extension"] = file_ext
            
            # APK fayllari uchun maxsus tekshiruv
            if file_ext == 'apk':
                risk_score += 8
                warnings.append("APK fayli - dastur o'rnatish fayli")
                results["details"]["is_apk"] = True
                
                # APK uchun maxsus so'zlar tekshirish
                for keyword in self.apk_suspicious_keywords:
                    if keyword in file_name_lower:
                        risk_score += 5
                        warnings.append(f"APK nomida shubhali so'z: '{keyword}'")
                        break
            
            # 2. Xavfli kengaytmalar
            for ext, score in self.dangerous_extensions.items():
                if file_name_lower.endswith(f'.{ext}'):
                    risk_score += score
                    warnings.append(f"Xavfli fayl turi: .{ext}")
                    results["verdict"] = "Suspicious" if results["verdict"] == "Safe" else results["verdict"]
            
            # 3. Shubhali kengaytmalar
            for ext, score in self.suspicious_extensions.items():
                if file_name_lower.endswith(f'.{ext}'):
                    risk_score += score
                    warnings.append(f"Shubhali fayl turi: .{ext}")
                    if results["verdict"] == "Safe":
                        results["verdict"] = "Caution"
            
            # 4. Shubhali so'zlar
            for keyword in self.suspicious_keywords:
                if keyword in file_name_lower:
                    risk_score += 5
                    warnings.append(f"Fayl nomida shubhali so'z: '{keyword}'")
                    if results["verdict"] == "Safe":
                        results["verdict"] = "Suspicious"
            
            # 5. Fayl hajmi
            if file_size > 100 * 1024 * 1024:  # 100MB
                risk_score += 10
                warnings.append(f"Fayl hajmi juda katta: {file_size/(1024*1024):.1f}MB")
            
            # 6. APK uchun maxsus ogohlantirish
            if file_ext == 'apk' and risk_score > 10:
                warnings.append("âš ï¸ Eslatma: APK fayllari virus yoki zararli dastur bo'lishi mumkin")
                warnings.append("âš ï¸ Faqat ishonchli manbalardan APK yuklang")
            
            # 7. MIME turi
            if mime_type:
                dangerous_mimes = [
                    'application/x-msdownload',  # Windows EXE
                    'application/x-dosexec',     # DOS executable
                    'application/x-executable',
                    'application/vnd.android.package-archive',  # APK
                    'application/java-archive',  # JAR
                    'application/x-java-applet',
                    'application/x-ms-shortcut'  # Windows shortcut
                ]
                
                if mime_type in dangerous_mimes:
                    risk_score += 15
                    warnings.append(f"Xavfli MIME turi: {mime_type}")
                    results["verdict"] = "Suspicious"
                
                results["details"]["mime_analysis"] = mime_type
            
            # Risk darajasi
            results["score"] = risk_score
            results["warnings"] = warnings
            
            if risk_score >= 70:
                results["risk_level"] = "Critical"
                results["verdict"] = "Malicious"
            elif risk_score >= 50:
                results["risk_level"] = "High"
                results["verdict"] = "Suspicious"
            elif risk_score >= 30:
                results["risk_level"] = "Medium"
                results["verdict"] = "Caution"
            elif risk_score >= 15:
                results["risk_level"] = "Low"
                results["verdict"] = "Low Risk"
            else:
                results["risk_level"] = "Safe"
                results["verdict"] = "Safe"
            
            return results
            
        except Exception as e:
            logger.error(f"Telegram file analysis error: {e}")
            results["warnings"].append(f"Tahlil xatosi: {str(e)}")
            results["verdict"] = "Error"
            return results
    
    def _get_file_extension(self, file_name: str) -> str:
        """Fayl kengaytmasini olish"""
        if '.' in file_name:
            return file_name.split('.')[-1].lower()
        return ""
    
    def get_file_verdict_message(self, analysis_result: Dict) -> str:
        """Fayl tahlili natijasiga asoslangan xabar tayyorlash"""
        verdict = analysis_result.get("verdict", "Safe")
        file_name = analysis_result.get("file_name", "Noma'lum fayl")
        risk_level = analysis_result.get("risk_level", "Low")
        warnings = analysis_result.get("warnings", [])
        score = analysis_result.get("score", 0)
        file_size = analysis_result.get("file_size", 0)
        
        if verdict == "Malicious":
            emoji = "ğŸ”´"
            title = "XAVFLI FAYL!"
            action = "BU FAYLNI OCHMANG VA YUKLAMANG!"
        elif verdict == "Suspicious":
            emoji = "ğŸŸ¡"
            title = "SHUBHALI FAYL"
            action = "EHTIYOT BO'LING!"
        elif verdict == "Caution":
            emoji = "ğŸŸ "
            title = "DIQQAT KERAK"
            action = "Tekshirmasdan ochmang!"
        elif verdict == "Low Risk":
            emoji = "ğŸ”µ"
            title = "PAST XAVF"
            action = "Odatiy ehtiyot choralarni oling"
        else:
            emoji = "ğŸŸ¢"
            title = "XAVFSIZ"
            action = "Faylni ochishingiz mumkin"
        
        message = f"{emoji} <b>{title}</b>\n\n"
        message += f"ğŸ“ <b>Fayl:</b> <code>{file_name}</code>\n"
        
        if file_size > 0:
            message += f"ğŸ“Š <b>Hajm:</b> {file_size/(1024*1024):.2f} MB\n"
        
        message += f"ğŸ›¡ï¸ <b>Xavf darajasi:</b> {risk_level}\n"
        message += f"ğŸ“ˆ <b>Risk bahosi:</b> {score}/100\n\n"
        
        if warnings:
            message += "âš ï¸ <b>Ogohlantirishlar:</b>\n"
            for i, warning in enumerate(warnings[:4], 1):
                message += f"{i}. {warning}\n"
            message += "\n"
        
        # APK uchun maxsus maslahat
        if '.apk' in file_name.lower():
            message += "ğŸ“± <b>APK uchun maslahat:</b>\n"
            message += "â€¢ Faqat Google Play Store dan yuklang\n"
            message += "â€¢ Noma'lum manbalardan APK yuklamang\n"
            message += "â€¢ Yuklashdan oldin izohlarni o'qing\n\n"
        
        message += f"âŒ <b>{action}</b>\n\n"
        
        if verdict in ["Malicious", "Suspicious"]:
            message += "ğŸ’¡ <i>Bu turdagi fayllar virus, troyan yoki boshqa zararli dastur bo'lishi mumkin.</i>"
        
        return message

# Global obyekt
file_analyzer = AdvancedFileAnalyzer()